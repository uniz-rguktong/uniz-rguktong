name: Vercel Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  # PHASE 1: Build Once (The One True Build)
  Build-Monorepo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Use npm cache for speed

      - name: Install Dependencies
        run: npm ci

      - name: Validate Dependency Graph
        # Ensure we have a valid turbo graph before proceeding
        run: npx turbo run build --dry-run

      - name: Build All Workspaces
        # This builds shared libs AND applications completely.
        # artifacts will be in dist/ or .next/ folders.
        run: npx turbo run build

      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monorepo-build-artifacts
          path: |
            apps/*/dist
            apps/*/.next
            apps/*/public
            apps/*/package.json
            apps/*/vercel.json
            packages/*/dist
            packages/*/package.json
            package.json
            package-lock.json
            turbo.json
          retention-days: 1

  # PHASE 2: Deploy Many (Using Artifacts)
  Deploy-Services:
    needs: Build-Monorepo
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, outpass, academics, files, mail, notification, cron, web]
        include:
          - service: gateway
            project_name: uniz-production-gateway
    steps:
      - uses: actions/checkout@v4
      
      # We don't need full node install here if we just use Vercel CLI to upload prebuilt artifacts,
      # but standard Vercel CLI often needs node runtime.
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: monorepo-build-artifacts
          # Download to current directory structure
          path: .
          
      - name: Deploy ${{ matrix.service }}
        env:
          PROJECT_NAME: ${{ matrix.project_name || format('uniz-{0}-service', matrix.service) }}
        run: |
          # The artifacts are already downloaded into the correct structure (apps/auth/dist etc)
          # We just point Vercel to the app folder and say "Go"
          
          echo "Linking $PROJECT_NAME..."
          vercel link --project $PROJECT_NAME --scope $VERCEL_ORG_ID --token $VERCEL_TOKEN --yes
          
          echo "Pulling Env..."
          vercel pull --yes --environment=production --scope $VERCEL_ORG_ID --token $VERCEL_TOKEN
          
          # CRITICAL: We use --prebuilt because we ALREADY built everything in the Build job.
          # But Vercel CLI "build" command transforms artifacts into .vercel/output.
          # Since our simple apps (dist/) might not be in Vercel's internal format yet, we have two choices:
          # A) Let Vercel build remotely (we fixed workspaces so this works now)
          # B) Run `vercel build` locally here using the artifacts.
          
          # Since we want to use the "Build Once" artifacts, strictly speaking we should use them.
          # However, Vercel's `vercel build` logic is what wires up the serverless functions.
          # Since we are in a clean state with artifacts, running `vercel build` here is safe 
          # because it just packages the existing JS files into Cloud Functions.
          
          echo "Packaging for Vercel..."
          # This step converts our 'dist' output into .vercel/output ready for upload
          vercel build --prod --scope $VERCEL_ORG_ID --token $VERCEL_TOKEN
          
          echo "Uploading to Vercel..."
          vercel deploy --prebuilt --prod --scope $VERCEL_ORG_ID --token $VERCEL_TOKEN
