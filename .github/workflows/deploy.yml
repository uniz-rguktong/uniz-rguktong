name: Vercel Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  Deploy-Services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, outpass, academics, files, mail, notification, cron, web]
        include:
          - service: gateway
            project_name: uniz-production-gateway
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Workspaces (Validate)
        run: npx turbo run build

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy ${{ matrix.service }}
        env:
          PROJECT_NAME: ${{ matrix.project_name || format('uniz-{0}-service', matrix.service) }}
          ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          cd apps/${{ matrix.service }}
          
          # Logic: Bundle Node APIs, Build Frontend Standardly
          if [ "${{ matrix.service }}" == "web" ]; then
             # Frontend (Vite) - Standard Remote Build (Vercel handles Vite well)
             # Note: We use Remote Build for frontend because it's static/SPA and Vercel optimization is good.
             vercel link --project $PROJECT_NAME --scope $ORG_ID --token $VERCEL_TOKEN --yes
             vercel pull --yes --environment=production --scope $ORG_ID --token $VERCEL_TOKEN
             vercel build --prod --scope $ORG_ID --token $VERCEL_TOKEN
             vercel deploy --prebuilt --prod --scope $ORG_ID --token $VERCEL_TOKEN
          
          else
             # Backend APIs - Use NCC Bundling Strategy
             echo "Bundling API with NCC..."
             # We installed @vercel/ncc in root, so use npx from root context or relative path?
             # npx resolves from local node_modules or downloads.
             npx @vercel/ncc build api/index.ts -o api
             
             # Swap TS for JS in Vercel's eyes (strict cleanup)
             # (Optional: Our vercel.json already points to api/index.js, so existence is enough)

             # Deploy
             vercel link --project $PROJECT_NAME --scope $ORG_ID --token $VERCEL_TOKEN --yes
             vercel pull --yes --environment=production --scope $ORG_ID --token $VERCEL_TOKEN
             
             # Skip 'vercel build' for APIs because we built it with NCC!
             # We just ship the prebuilt artifacts (which is the file system basically, plus .vercel/output from pull?)
             # Wait, --prebuilt REQUIRES .vercel/output.
             # NCC output is just files.
             
             # So we use 'vercel deploy --prod' (Remote Build) BUT...
             # Remote Build will fail install.
             
             # We MUST use 'vercel deploy --prod' (Upload Source) but since we have bundled JS, 
             # Vercel Runtime just runs it.
             # We DO NOT use --prebuilt for Backend then?
             
             # CORRECT: We upload the 'api/index.js' we just made.
             # Vercel sees source code. It installs deps? No deps (bundled).
             # It runs 'api/index.js'.
             
             # Important: We must ensure we don't upload the confusing TS files or node_modules.
             # But 'vercel deploy' respects .vercelignore.
             
             echo "Deploying Bundled API..."
             vercel deploy --prod --scope $ORG_ID --token $VERCEL_TOKEN
          fi
