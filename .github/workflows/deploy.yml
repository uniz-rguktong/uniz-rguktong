name: Vercel Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  # REMOVED GLOBAL VERCEL_ORG_ID to avoid "missing PROJECT_ID" error.
  # We will pass the Org ID explicitly via arguments where needed.

jobs:
  Build-Monorepo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build All Workspaces
        run: npx turbo run build

      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monorepo-build-artifacts
          path: |
            apps/*/dist
            apps/*/.next
            apps/*/public
            apps/*/package.json
            apps/*/vercel.json
            packages/*/dist
            packages/*/package.json
            package.json
            package-lock.json
            turbo.json
          retention-days: 1

  Deploy-Services:
    needs: Build-Monorepo
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [auth, user, outpass, academics, files, mail, notification, cron, web]
        include:
          - service: gateway
            project_name: uniz-production-gateway
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: monorepo-build-artifacts
          path: .
          
      - name: Deploy ${{ matrix.service }}
        env:
          PROJECT_NAME: ${{ matrix.project_name || format('uniz-{0}-service', matrix.service) }}
          ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          # 1. Link Project (Creates .vercel/project.json)
          # We pass --scope explicitly to auth correctly against the team
          echo "Linking $PROJECT_NAME..."
          vercel link --project $PROJECT_NAME --scope $ORG_ID --token $VERCEL_TOKEN --yes
          
          # 2. Pull Env Vars
          echo "Pulling Env..."
          vercel pull --yes --environment=production --scope $ORG_ID --token $VERCEL_TOKEN
          
          # 3. Package (Build) for Vercel
          # This converts the 'dist' we downloaded into '.vercel/output'
          # It uses the settings in vercel.json that we configured earlier
          echo "Packaging for Vercel..."
          vercel build --prod --scope $ORG_ID --token $VERCEL_TOKEN
          
          # 4. Deploy Prebuilt
          # This uploads the '.vercel/output' folder directly
          echo "Uploading to Vercel..."
          vercel deploy --prebuilt --prod --scope $ORG_ID --token $VERCEL_TOKEN
